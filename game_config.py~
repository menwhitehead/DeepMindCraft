import Action
import random
import os
from game_globals import *
from string import Template
import stat

# The width and height of the viewable game window (always square)
# For maximum speed, set this to 84 to match the scaled size (no scaling is required!)
VIEW_WINDOW_SIZE = 84

# The width and height of the image sent to DeepMind
SCALED_WINDOW_SIZE = 84

# The number of possible actions the agent can perform each step
TOTAL_NUMBER_ACTIONS = 18

# Host and port number for Lua DeepMind connection
TCP_HOST = "localhost"
TCP_PORT = 9999

TICKS_PER_SEC = 6000

# Total number of game frames per episode
MAXIMUM_GAME_FRAMES = 300

# Agent's turning speed (per tick)
AGENT_ROTATION_SPEED = 1.50
WALKING_SPEED = 1.0

# World generation parameters
WORLD_WIDTH = 5  # width in both directions from start
WORLD_DEPTH = 5  # depth in both directions from start
NUMBER_TOWERS = 8  # number of small towers of dirt to add randomly through world

# How often to print out the total number of frames 
COUNTER_DISPLAY_FREQUENCY = 1000

################
# Game Actions #
################
GAME_ACTIONS = [
    # (break_block, updown_rot, leftright_rot, forwardback, leftright)
    
    # Do nothing
    Action.Action(False, updown_rot=0.0, leftright_rot=0.0, forwardback=0, leftright=0),
    
    # Go forward
    Action.Action(False, updown_rot=0.0, leftright_rot=0.0, forwardback=WALKING_SPEED, leftright=0),
    
    # Go backward
    Action.Action(False, updown_rot=0.0, leftright_rot=0.0, forwardback=-WALKING_SPEED, leftright=0),
    
    # Rotate right
    Action.Action(False, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=0, leftright=0),
    # Rotate right and go forward
    #self.actions.append(Action.Action(False, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=1, leftright=0))
    
    # Rotate right and go backward
    #self.actions.append(Action.Action(False, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=-1, leftright=0))
    
    # Rotate left
    Action.Action(False, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=0, leftright=0),

    # Rotate left and go forward
    #self.actions.append(Action.Action(False, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=1, leftright=0))
    
    # Rotate left and go backward
    #self.actions.append(Action.Action(False, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=-1, leftright=0))    
    
    # Click
    Action.Action(True, updown_rot=0.0, leftright_rot=0.0, forwardback=0, leftright=0),
    
    # Click and go forward
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=0.0, forwardback=1, leftright=0))
    
    # Click and go backward
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=0.0, forwardback=-1, leftright=0))  
    
    # Click and rotate right
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=0, leftright=0))
    
    # Click and rotate right and go forward
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=1, leftright=0))
    
    # Click and rotate right and go backward
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=AGENT_ROTATION_SPEED, forwardback=-1, leftright=0))

    # Click and rotate left
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=0, leftright=0))
    
    # Click and rotate left and go forward
    #self.actions.append(Action.Action(True, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=1, leftright=0))

    # Click and rotate left and go backward
    #Action.Action(True, updown_rot=0.0, leftright_rot=-AGENT_ROTATION_SPEED, forwardback=-1, leftright=0),

    # Go right
    Action.Action(False, updown_rot=0.0, leftright_rot=0.0, forwardback=0, leftright=WALKING_SPEED),
    
    # Go left
    Action.Action(False, updown_rot=0.0, leftright_rot=0.0, forwardback=0, leftright=-WALKING_SPEED)
]

##############
# Game rules #
##############
# Rewards and penalties must fit into one byte!
# All accumulated rewards also must be non-negative!!!

# Rewards (these are added to reward)

# How much do you get for breaking different blocks?
BLOCK_BREAK_REWARDS = {
    "GRASS":100,
    "STONE":0
}

# Penalties (these are subtracted from reward)
SWING_PENALTY = 0
EXISTENCE_PENALTY = 0

# If you get all the penalties, then you get zero
STARTING_REWARD = SWING_PENALTY + EXISTENCE_PENALTY

##############
# Build World#
##############

GROUND = -2
WALL_HEIGHT = 2


def saveWorld(locations, filename):
    o = open("maps" + os.sep + filename, 'w')
    for location in locations:
        o.write("%d %d %d %s\n" % location)
    o.close()
    

def generateGrassTower(locations):
    randomX = random.randrange(-WORLD_WIDTH+1, WORLD_WIDTH-1)
    randomZ = random.randrange(-WORLD_DEPTH+1, WORLD_DEPTH-1)
    
    for i in range(1, 2):
        locations.append((randomX, GROUND+i+1, randomZ, "GRASS"))
    
    return locations

def generateFlatWorld(locations):
    
    # Make the flat ground
    for i in range(-WORLD_WIDTH, WORLD_WIDTH):
        for j in range(-WORLD_DEPTH, WORLD_DEPTH):
            locations.append((i, GROUND, j, "STONE"))

    # Put walls around the outside
    for i in range(-2, WALL_HEIGHT):
        for j in range(-WORLD_DEPTH, WORLD_DEPTH):
            locations.append((-WORLD_WIDTH, i, j, "STONE"))
            locations.append((WORLD_WIDTH, i, j, "STONE"))
        for j in range(-WORLD_WIDTH, WORLD_WIDTH):
            locations.append((j, i, -WORLD_DEPTH, "STONE"))
            locations.append((j, i, WORLD_DEPTH, "STONE"))

    return locations


def generateGameWorld(filename):
    locs = []
    locs = generateFlatWorld(locs)
    for i in range(NUMBER_TOWERS):
        locs = generateGrassTower(locs)
    saveWorld(locs, filename)

#################
# Write Scripts #
#################

def write_script(template_name, new_file_name, replacements):
    template = open(template_name, "r")
    new_file = open(new_file_name, "w")
    curr_replacement = 0
    filled_template = Template(template.read()).substitute(replacements)
    new_file.write(filled_template)
    template.close()
    new_file.close()
    st = os.stat(new_file_name)
    os.chmod(new_file_name, st.st_mode | stat.S_IEXEC)

if __name__ == "__main__":
    GAME_ENVIRONMENT_TEMPLATE = "GameEnvironment_template"
    GAME_ENVIRONMENT_REPLACEMENTS = {"ACTION_NUMBER" :len(GAME_ACTIONS)}
    
    write_script(GAME_ENVIRONMENT_TEMPLATE, "test.lua", GAME_ENVIRONMENT_REPLACEMENTS)
